<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
  </head>
  <body>
    <h1>Data Selfie App</h1>
    <p><a href="index.html">index</a> | <a href="all.html">log</a></p>
    <p>
      latitude: <span id="lat"></span>°<br />
      longitude: <span id="lon"></span>°<br />
    </p>
    <p>The weather here is <span id="summary"></span> with a temperature of <span id="temperature"></span>&deg; F.</p>
    <p>The concentration of particulate matter (<span id="aq_parameter"></span>) is <span id="aq_value"></span> <span id="aq_units"></span> last read on <span id="aq_date"></span>.</p>

    <button type="submit" onclick="saveLocation()">Submit</button>
    
    <script async defer>

      function toFixedNumber(num, digits){
        var pow = Math.pow(10, digits);
        return Math.round(num * pow) / pow;
      }

      async function errorCheck(func) {
        try {
          const data = await func();
          return [data, null];
        } catch(error) {
          return [null, error];
        }
      }

      async function errorCheckVariadic(func, argArray) {
        try {
          const data = await func(...argArray);
          return [data, null];
        } catch(error) {
          return [null, error];
        }
      }

      function saveLocation() {
        if ('geolocation' in navigator) {
          console.log('geolocation available');

          navigator.geolocation.getCurrentPosition( async position => {
            const lat = toFixedNumber(position.coords.latitude, 4);
            const lon = toFixedNumber(position.coords.longitude, 4);
            document.getElementById('lat').textContent = lat.toFixed(2);
            document.getElementById('lon').textContent = lon.toFixed(2);          
            // console.log(position);

            async function getWeather(latitude, longitude) {
              const apiURL = `/weather/${latitude},${longitude}`;
              const weatherResponse = await fetch(apiURL);
              const atmoJSON = await weatherResponse.json();
              console.log(atmoJSON);

              const weatherSum = atmoJSON.weather.weather[0].main;
              const weatherTemp = atmoJSON.weather.main.temp;

              document.getElementById('summary').textContent = weatherSum;
              document.getElementById('temperature').textContent = weatherTemp;

              return atmoJSON;
            }

            const [data1, error1] = await errorCheckVariadic(getWeather, [lat, lon]);
            // console.log(data1);
            // console.log(error1);

            if (error1) {
              console.error(error1);
              document.getElementById('summary').textContent = 'NO READING';
              document.getElementById('temperature').textContent = 'NO READING';
            }

            function displayAirQuality(aqData) {             
              const airQuality = aqData.air_quality.results[0].measurements[1];

              document.getElementById('aq_parameter').textContent = airQuality.parameter;
              document.getElementById('aq_value').textContent = airQuality.value;
              document.getElementById('aq_units').textContent = airQuality.unit;
              document.getElementById('aq_date').textContent = airQuality.lastUpdated;

              return true;
            } 

            const [ok, error2] = await errorCheckVariadic(displayAirQuality, [data1]);
            console.log(ok);
            console.log(error2);

            if (error2) {
              console.error(error2);
              airQuality = { value: -1 };
              document.getElementById('aq_value').textContent = 'NO READING';
            }

            const data = { lat, lon };
            // console.log(data);

            // request options, request must use valid body data type
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              // convert object to JSON string for server
              body: JSON.stringify(data) 
            };

            const response = await fetch('/api', options);
            const json = await response.json(); // parses JSON response into native JavaScript objects
            // console.log(json);
          }); // end getCurrentPosition
        } else {
          console.log('geolocation not available');
        }
      } 
    </script>
  </body>
</html>