<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="" />
    <link href="./output.css" rel="stylesheet" />
  </head>
  <body>
    <h1 class="text-3xl font-bold text-clifford">Hello world!</h1>
    <p><a href="index.html">index</a> | <a href="all.html">log</a></p>
    <p>
      latitude: <span id="lat"></span>°<br />
      longitude: <span id="lon"></span>°<br />
    </p>
    <p><span id="city"></span><br /></p>
    <p><span id="img_weatherIcon"></span><br /></p>
    <p>
      The weather here is <span id="summary"></span> with a temperature of
      <span id="temperature"></span>&deg; F.
    </p>
    <p>
      <span id="aq_city"></span><br />
      The concentration of particulate matter (<span id="aq_parameter"></span>) is
      <span id="aq_value"></span> <span id="aq_units"></span> last read on
      <span id="aq_date"></span>.
    </p>

    <button type="submit" onclick="saveLocation()">Submit</button>

    <script async defer>
      function toFixedNumber(num, digits) {
        var pow = Math.pow(10, digits);
        return Math.round(num * pow) / pow;
      }

      function saveLocation() {
        if ("geolocation" in navigator) {
          console.log("geolocation available");

          navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = toFixedNumber(position.coords.latitude, 4);
            const lon = toFixedNumber(position.coords.longitude, 4);

            try {
              document.getElementById("lat").textContent = lat.toFixed(2);
              document.getElementById("lon").textContent = lon.toFixed(2);
              // console.log(position);

              const apiWeatherURL = `/weather/${lat},${lon}`;
              const weatherResponse = await fetch(apiWeatherURL);
              const atmoJSON = await weatherResponse.json();
              console.log(atmoJSON);

              const weatherCity = atmoJSON.weather.name;
              const weatherSum = atmoJSON.weather.weather[0].main;
              const weatherTemp = atmoJSON.weather.main.temp;
              const weatherIcon = atmoJSON.weather.weather[0].icon;

              function addimage() {
                var img = new Image();
                img.src = `https://openweathermap.org/img/wn/${weatherIcon}@2x.png`;
                img_weatherIcon.appendChild(img);
              }

              addimage();

              document.getElementById("city").textContent = weatherCity;
              document.getElementById("summary").textContent = weatherSum;
              document.getElementById("temperature").textContent = weatherTemp;

              try {
                const airQualityCities = atmoJSON.air_quality.results;
                const airQualityCity = airQualityCities[0];
                const airQualitySensors = airQualityCity.sensors;
                let sensorId = airQualitySensors[0];

                for (const element of airQualitySensors) {
                  if (element.name.includes("pm25")) sensorId = element.id;
                }

                const apiAirQualityURL = `/air_quality/${sensorId}`;
                const airQualityResponse = await fetch(apiAirQualityURL);
                const airQualityJSON = await airQualityResponse.json();
                console.log(airQualityJSON);

                const airQuality = airQualityJSON.measurements.results[0];
                const airQualityLatestDate = new Date(airQuality.latest.datetime.local);

                document.getElementById("aq_city").textContent = airQualityCity.name;
                document.getElementById("aq_parameter").textContent =
                  airQuality.parameter.displayName;
                document.getElementById("aq_units").textContent = airQuality.parameter.units;
                document.getElementById("aq_value").textContent = airQuality.latest.value;
                document.getElementById("aq_date").textContent =
                  airQualityLatestDate.toLocaleString();
              } catch (error) {
                console.error(error);
                airQuality = { value: -1 };
                document.getElementById("aq_value").textContent = "NO READING";
              }
            } catch (error) {
              console.error(error);
              document.getElementById("summary").textContent = "NO READING";
              document.getElementById("temperature").textContent = "NO READING";
            }

            const data = { lat, lon };
            // console.log(data);

            // request options, request must use valid body data type
            const options = {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              // convert object to JSON string for server
              body: JSON.stringify(data),
            };

            const response = await fetch("/api", options);
            const json = await response.json(); // parses JSON response into native JavaScript objects
            // console.log(json);
          }); // end getCurrentPosition
        } else {
          console.log("geolocation not available");
        }
      }
    </script>
  </body>
</html>
